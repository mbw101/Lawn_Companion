package com.mbw101.lawn_companion.database

import android.content.Context
import androidx.room.Room
import androidx.test.core.app.ApplicationProvider
import androidx.test.runner.AndroidJUnit4
<<<<<<< HEAD
import kotlinx.coroutines.runBlocking
import org.junit.After
import org.junit.Assert
=======
import com.mbw101.lawn_companion.utils.UtilFunctions
import junit.framework.Assert.assertEquals
import kotlinx.coroutines.runBlocking
import org.junit.After
>>>>>>> origin/develop
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.annotation.Config

@RunWith(AndroidJUnit4::class)
@Config(sdk = [28])
class CutDatabaseTest {

<<<<<<< HEAD
    private lateinit var db: CutEntryDatabase
=======
    private lateinit var db: AppDatabase
>>>>>>> origin/develop
    private lateinit var cutEntryDao: CutEntryDAO

    @Before
    fun setUp() {
        val context: Context = ApplicationProvider.getApplicationContext<Context>()
<<<<<<< HEAD
        db = Room.inMemoryDatabaseBuilder(context, CutEntryDatabase::class.java)
=======
        db = Room.inMemoryDatabaseBuilder(context, AppDatabase::class.java)
>>>>>>> origin/develop
            .allowMainThreadQueries()
            .build()
        cutEntryDao = db.cutEntryDao()
    }

    @Test
    @Throws(Exception::class)
    fun testNumEntries() = runBlocking {
<<<<<<< HEAD
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
            CutEntry("4:36pm", 5, "October", 10),
            CutEntry("4:36pm", 28, "September", 9),
            CutEntry("4:36pm", 1, "October", 10))

        Assert.assertEquals(cutEntryDao.getNumEntries(), 4)
=======
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear()))

        assertEquals(cutEntryDao.getNumEntries(), 4)
>>>>>>> origin/develop
    }

    @Test
    @Throws(Exception::class)
    //  Tests the get all cuts by adding 3 CutEntries and ensuring a list with 3 entries are returned
    fun insertAndGetAllCuts() = runBlocking {
<<<<<<< HEAD
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
            CutEntry("4:36pm", 28, "September", 9),
            CutEntry("4:36pm", 5, "October", 10))

        val returnedList = cutEntryDao.getAllCuts()

        Assert.assertEquals(cutEntryDao.getNumEntries(), 3)
    }

//    @Test
//    @Throws(Exception::class)
//    fun insertAndFindByMonthName() = runBlocking {
//        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
//            CutEntry("4:36pm", 28, "September", 9),
//            CutEntry("4:36pm", 5, "October", 10))
//
//        var returnedEntries = cutEntryDao.findByMonthName("October")
//        runBlocking {
//            returnedEntries.collect { entries ->
//                Assert.assertEquals(entries.size, 1)
//            }
//        }
//
//        returnedEntries = cutEntryDao.findByMonthName("September")
//        runBlocking {
//            returnedEntries.collect { entries ->
//                Assert.assertEquals(entries.size, 2)
//            }
//        }
//    }
//
//    @Test
//    @Throws(Exception::class)
//    fun insertAndFindByMonthNum() {
//        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
//            CutEntry("4:36pm", 28, "September", 9),
//            CutEntry("4:36pm", 5, "October", 10))
//
//        var returnedEntries = cutEntryDao.findByMonthNum(10)
//        runBlocking {
//            returnedEntries.collect { entries ->
//                Assert.assertEquals(entries.size, 1)
//            }
//        }
//
//        returnedEntries = cutEntryDao.findByMonthNum(9)
//        runBlocking {
//            returnedEntries.collect { entries ->
//                Assert.assertEquals(entries.size, 2)
//            }
//        }
//    }
//
//    @Test
//    @Throws(Exception::class)
//    fun testFindLastCut() {
//        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
//            CutEntry("4:36pm", 5, "October", 10),
//            CutEntry("4:36pm", 28, "September", 9),
//            CutEntry("4:36pm", 1, "October", 10))
//
//        val returnedEntry = cutEntryDao.getLastCut()
//        returnedEntry.collect { entry ->
//            Assert.assertEquals(entry.month_name, "October")
//            Assert.assertEquals(entry.day_number, 5)
//        }
//    }
//
//    @Test
//    @Throws(Exception::class)
//    fun testDeleteCut() {
//        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
//            CutEntry("4:36pm", 5, "October", 10),
//            CutEntry("4:36pm", 28, "September", 9),
//            CutEntry("4:36pm", 1, "October", 10))
//
//        // delete both the october cuts and check each time afterwards
//        cutEntryDao.deleteCuts(CutEntry("4:36pm", 1, "October", 10))
//        var returnedEntry = cutEntryDao.getLastCut()
//        runBlocking {
//            returnedEntry.collect { entry ->
//                Assert.assertEquals(entry.month_name, "October")
//            }
//        }
//
//        cutEntryDao.deleteCuts(CutEntry("4:36pm", 5, "October", 10))
//        returnedEntry = cutEntryDao.getLastCut()
//        runBlocking {
//            returnedEntry.collect { entry ->
//                Assert.assertEquals(entry.month_name, "September")
//            }
//        }
//
//        // check size after deleting
//        val remainingEntries = cutEntryDao.getAllCuts()
//        Assert.assertEquals(cutEntryDao.getNumEntries(), 2)
//    }
=======
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()))

        assertEquals(cutEntryDao.getNumEntries(), 3)
    }

    @Test
    @Throws(Exception::class)
    fun insertAndFindByMonthName() = runBlocking {
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()))

        var returnedEntries: List<CutEntry>? = null
        runBlocking {
            returnedEntries = cutEntryDao.findByMonthName("October")
            assertEquals(returnedEntries!!.size, 1)
        }

        runBlocking {
            returnedEntries = cutEntryDao.findByMonthName("September")
            assertEquals(returnedEntries!!.size, 2)
        }
    }

    @Test
    @Throws(Exception::class)
    fun insertAndFindByMonthNum() {
        runBlocking {
            cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()))

            var returnedEntries = cutEntryDao.findByMonthNum(10)
            assertEquals(returnedEntries!!.size, 1)

            returnedEntries = cutEntryDao.findByMonthNum(9)
            assertEquals(returnedEntries!!.size, 2)
        }
    }

    @Test
    @Throws(Exception::class)
    fun testFindLastCut() {
        runBlocking {
            cutEntryDao.insertAll(
                CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear())
            )

            val returnedEntry = cutEntryDao.getLastCut()
            assertEquals(returnedEntry!!.month_name, "October")
            assertEquals(returnedEntry.day_number, 5)
        }
    }

    @Test
    @Throws(Exception::class)
    fun testFindAllCutsWithYear() {
        runBlocking {
            cutEntryDao.insertAll(
                CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear())
            )

            var entriesFromCurrentYear = cutEntryDao.getEntriesFromSpecificYear(UtilFunctions.getCurrentYear())
            assertEquals(entriesFromCurrentYear.size, 4)

            cutEntryDao.insertAll(
                CutEntry("4:36pm", 28, "September", 9, 2020),
                CutEntry("4:36pm", 1, "October", 10, 2020)
            )

            entriesFromCurrentYear = cutEntryDao.getEntriesFromSpecificYear(2020)
            assertEquals(entriesFromCurrentYear.size, 2)
            entriesFromCurrentYear = cutEntryDao.getEntriesFromSpecificYear(2019)
            assertEquals(entriesFromCurrentYear.isEmpty(), true)
        }
    }

    @Test
    @Throws(Exception::class)
    fun testFindLastEntryFromPreviousYear() {
        runBlocking {
            cutEntryDao.insertAll(
                CutEntry("4:36pm", 5, "October", 10, 2020),
                CutEntry("4:36pm", 17, "September", 9, 2020),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear())
            )

            var lastEntryFrom2020 = cutEntryDao.getLastEntryFromSpecificYear(2020)
            assertEquals(lastEntryFrom2020!!.day_number, 5) // oct 5th, 2020 is the last entry of 2020
            assertEquals(lastEntryFrom2020.month_number, 10)

            cutEntryDao.insertAll(
                CutEntry("4:36pm", 5, "December", 12, 2020)
            )

            lastEntryFrom2020 = cutEntryDao.getLastEntryFromSpecificYear(2020)
            assertEquals(lastEntryFrom2020!!.day_number, 5)
            assertEquals(lastEntryFrom2020.month_number, 12)
            assertEquals(cutEntryDao.getLastEntryFromSpecificYear(2019), null)
        }
    }

    // sorting queries
    @Test
    @Throws(Exception::class)
    fun testFindAllCutsWithYearSorted() {
        runBlocking {
            cutEntryDao.insertAll(
                CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear())
            )

            var entriesFromCurrentYear = cutEntryDao.getEntriesFromSpecificYearSortedAsync(UtilFunctions.getCurrentYear())
            assertEquals(entriesFromCurrentYear.size, 4)
            assertEquals(entriesFromCurrentYear[0].day_number, 17)
            assertEquals(entriesFromCurrentYear[1].day_number, 28)
            assertEquals(entriesFromCurrentYear[2].day_number, 1)
            assertEquals(entriesFromCurrentYear[3].day_number, 5)

            cutEntryDao.insertAll(
                CutEntry("4:36pm", 1, "September", 10, 2020)
            )

            entriesFromCurrentYear = cutEntryDao.getEntriesFromSpecificYearSortedAsync(2020)
            assertEquals(entriesFromCurrentYear[0].day_number, 1)
            entriesFromCurrentYear = cutEntryDao.getEntriesFromSpecificYearSortedAsync(2019)
            assertEquals(entriesFromCurrentYear.isEmpty(), true)
        }
    }

    @Test
    @Throws(Exception::class)
    fun testFindAllCutsSorted() {
        runBlocking {
            cutEntryDao.insertAll(
                CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear())
            )

            var entriesFromCurrentYear = cutEntryDao.getAllCutsSortedAsync()
            assertEquals(entriesFromCurrentYear.size, 4)
            assertEquals(entriesFromCurrentYear[0].day_number, 17)
            assertEquals(entriesFromCurrentYear[1].day_number, 28)
            assertEquals(entriesFromCurrentYear[2].day_number, 1)
            assertEquals(entriesFromCurrentYear[3].day_number, 5)

            cutEntryDao.insertAll(
                CutEntry("4:36pm", 1, "September", 9, 2020)
            )

            entriesFromCurrentYear = cutEntryDao.getAllCutsSortedAsync()
            assertEquals(entriesFromCurrentYear[0].day_number, 1)
        }
    }

    @Test
    @Throws(Exception::class)
    fun testDeleteCut() {
        runBlocking {
            cutEntryDao.insertAll(
                CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
                CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear())
            )

            // delete both the october cuts and check each time afterwards
            cutEntryDao.deleteCuts(CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear()))
            var returnedEntry = cutEntryDao.getLastCut()
            assertEquals(returnedEntry!!.month_name, "October")

            cutEntryDao.deleteCuts(CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()))
            returnedEntry = cutEntryDao.getLastCut()
            assertEquals(returnedEntry!!.month_name, "September")

            // check size after deleting
            val remainingEntries = cutEntryDao.getAllCuts()
            assertEquals(cutEntryDao.getNumEntries(), 2)
        }
    }
>>>>>>> origin/develop

    @Test
    @Throws(Exception::class)
    fun testDeleteAllCuts() = runBlocking {
<<<<<<< HEAD
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9),
            CutEntry("4:36pm", 5, "October", 10),
            CutEntry("4:36pm", 28, "September", 9),
            CutEntry("4:36pm", 1, "October", 10))
=======
        cutEntryDao.insertAll(CutEntry("4:36pm", 17, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 5, "October", 10, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 28, "September", 9, UtilFunctions.getCurrentYear()),
            CutEntry("4:36pm", 1, "October", 10, UtilFunctions.getCurrentYear()))
>>>>>>> origin/develop

        // delete both the october cuts and check each time afterwards
        cutEntryDao.deleteAll()

        // check size after deleting
        val remainingEntries = cutEntryDao.getAllCuts()
<<<<<<< HEAD
        Assert.assertEquals(cutEntryDao.getNumEntries(), 0)
=======
        assertEquals(cutEntryDao.getNumEntries(), 0)
>>>>>>> origin/develop
    }

    @After
    fun tearDown() {
        db.close()
    }
}